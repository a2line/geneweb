const CheckData=(()=>{'use strict';const C=new WeakMap(),V=new Set(),R=requestAnimationFrame;let _c=null,_o='';const S={err:'.err',editContainer:'.edit-container',bk:'.bk',pl:".pl",s2:'.s2',button:'button:not([data-action])',inputField:'input, textarea',disabled:'disabled',validated:'validated',editing:'editing'},ib=()=>{if(!_c)return;qa(S.bk,_c).forEach(b=>{if(!b.dataset.init){b.className='bk btn btn-primary';b.innerHTML='<i class="fa fa-book fa-xs"></i>';b.dataset.init='1'}});qa(S.pl,_c).forEach(b=>{if(!b.dataset.init){b.className='pl btn btn-success';b.innerHTML='<i class="fa fa-users fa-xs"></i>';b.target='_blank';b.dataset.init='1'}});qa(S.s2,_c).forEach(b=>{if(!b.dataset.init){b.classList.add('btn','btn-info');b.target='_blank';if(!b.innerHTML.includes('<i'))b.innerHTML='<i class="fa fa-check"></i>';b.dataset.init='1'}})},q=(s,c)=>(c||document).querySelector(s),qa=(s,c)=>Array.from((c||document).querySelectorAll(s)),iv=e=>{if(!e)return!1;const s=getComputedStyle(e);return s.visibility!=='hidden'&&s.display!=='none'},cf=(t,v)=>{const f=document.createElement(t?'textarea':'input');f.className='form-control';f.value=v;if(!t)f.type='text';return f},cc=(b,f)=>{const c=document.createElement('div');c.className=S.editContainer.slice(1);const o=document.createElement('div');o.className='original-content';o.innerHTML=b.innerHTML;c.appendChild(o);c.appendChild(f);C.set(c,{btn:b});return c},hc=e=>{const t=e.target,er=t.closest(S.err);if(er?.classList.contains(S.disabled)&&!t.closest(S.s2)){e.preventDefault();return}const p=t.closest(S.pl);if(p?.closest(S.err)){e.preventDefault();hp(p);return}const b=t.closest(S.button);if(b?.closest(S.err)){e.preventDefault();se(b);return}const s=t.closest(S.s2);if(s?.closest(S.err)){e.preventDefault();ve(s,s.closest(S.err))}},hk=e=>{const k=e.key;if(k!=='ArrowDown'&&k!=='ArrowUp')return;const er=document.activeElement?.closest(S.err);if(er&&!$(S.editContainer,er)){e.preventDefault();nv(er,k==='ArrowUp')}},hp=b=>{const er=b.closest(S.err),s=q(S.s2,er),u=new URL(s.href),d=u.searchParams.get('d'),s1=u.searchParams.get('s'),k=u.searchParams.get('k'),bu=`${u.origin}${u.pathname}`,nu=`${bu}?m=CHK_DATA_L&data=${d}&k=${s1}&key=${k}`;window.open(nu,'_blank')},se=b=>{const er=b.closest(S.err);if(er.classList.contains(S.editing))return;const v=er.dataset.ori||'',s=q(S.s2,er),h=s?.style.visibility==='hidden';if(s&&!s.dataset.origHidden)s.dataset.origHidden=h?'1':'0';er.classList.add(S.editing);const f=cf(v.length>115||v.includes('\n'),v),c=cc(b,f);b.replaceWith(c);R(()=>{f.focus();f.setSelectionRange(v.length,v.length);if(f.tagName==='TEXTAREA'&&window.autosize)autosize(f)});sf(f,c,s,v,h)},sf=(f,c,s,ov,wh)=>{const a={href:s?.href,title:s?.title||''};let st=!1;const hi=()=>{if(!s)return;const nv=f.value.trim(),ch=nv!==ov&&nv!=='';if(!st){s.dataset.origHref=a.href;s.dataset.origTitle=a.title;st=!0}R(()=>{if(ch){const h=s.dataset.origHref||a.href;s.href=h.includes('&s2=')?h.replace(/(&s2=)[^&]*/,`$1${encodeURIComponent(nv)}`):`${h}&s2=${encodeURIComponent(nv)}`;s.className='s2 btn btn-warning';s.style.visibility='visible';s.title=_o}else{s.href=a.href;s.className='s2 btn btn-success';s.style.visibility=wh?'hidden':'visible';s.title=a.title}})},hky=e=>{const k=e.key,er=c.closest(S.err);if(k==='Enter'){e.preventDefault();if(s?.style.visibility!=='hidden'){s.focus();ve(s,er)}}else if(k==='Escape'){e.preventDefault();ce(c,s,wh)}else if(k==='ArrowDown'||k==='ArrowUp'){e.preventDefault();nv(er,k==='ArrowUp')}},hb=e=>{if(e.relatedTarget===s)return;setTimeout(()=>{if(document.activeElement!==f&&document.activeElement!==s)ce(c,s,wh)},200)};f.addEventListener('input',hi);f.addEventListener('keydown',hky);f.addEventListener('blur',hb)},ce=(c,s,wh)=>{const er=c?.closest(S.err);if(!er)return;er.classList.remove(S.editing);const ch=C.get(c);if(ch?.btn&&c.parentNode){try{c.replaceWith(ch.btn.cloneNode(!0))}catch{}}if(s&&!s.classList.contains('btn-info')){s.className='s2 btn btn-success';if(s.dataset.origHref){s.href=s.dataset.origHref;s.title=s.dataset.origTitle||''}}},nv=(cu,gu=!1)=>{if(!cu)return;if(!cu.classList.contains(S.validated)){const c=q(S.editContainer,cu);if(c){const s=q(S.s2,cu);ce(c,s,s?.dataset.origHidden==='1')}}const al=qa(S.err),ix=al.indexOf(cu),st=gu?-1:1;let nx;for(let i=ix+st;gu?i>=0:i<al.length;i+=st){if(!al[i].classList.contains(S.disabled)){nx=al[i];break}}if(!nx)return;const s=q(S.s2,nx),au=s?.classList.contains('btn-info');R(()=>{if(au&&iv(s)){s.focus();s.scrollIntoView({behavior:'smooth',block:'center'})}else{const b=q(S.button,nx);if(b){b.click();b.scrollIntoView({behavior:'smooth',block:'center'})}}})},ve=async(s,er)=>{if(!s||!er)return;const k=s.href;if(V.has(k))return;V.add(k);const o=s.innerHTML;s.innerHTML='<i class="fa fa-spinner fa-spin"></i>';s.className='s2 btn btn-info';let v=null;const c=q(S.editContainer,er);if(c){const f=q(S.inputField,c);if(f)v=f.value.trim()}if(!v){const p=new URLSearchParams(s.href.split('?')[1]);v=p.get('s2')}try{const r=await fetch(`${s.href}&ajax`,{method:'GET',headers:{'Accept':'application/json','X-Requested-With':'XMLHttpRequest'}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const rs=await r.json();if(rs.success){no('success',`✔ ${rs.message}`);cv(er,s,rs.after||v);if(rs.nb_modified!==null&&rs.elapsed_time!==null){const sd=document.createElement('div');sd.className='small text-center mr-2';sd.innerHTML=`+${rs.nb_modified}<br>${rs.elapsed_time.toFixed(1)} s`;const sb=er.querySelector('.s2');if(sb)er.insertBefore(sd,sb)}setTimeout(()=>nv(er),300)}else{no('error',`✗ ${rs.message}`);s.innerHTML='<i class="fa fa-exclamation-triangle"></i>';s.className='s2 btn btn-danger';s.title=rs.message;setTimeout(()=>{s.innerHTML=o;s.className='s2 btn btn-warning'},2000)}}catch(e){console.error('AJAX error:',e);s.innerHTML=o;s.className='s2 btn btn-warning';window.open(s.href,'_blank')}finally{V.delete(k)}},cv=(er,s,v)=>{R(()=>{s.innerHTML='<i class="fa fa-spell-check"></i>';s.className='s2 btn btn-success';s.style.pointerEvents='none';s.style.visibility='visible';let c=q(S.editContainer,er);const b=q(S.button,er);if(c){const f=q(S.inputField,c);if(f&&v){const t=document.createElement('div');t.className='text-muted';t.textContent=v;f.replaceWith(t)}}else if(b&&v){c=document.createElement('div');c.className=S.editContainer.slice(1);const o=document.createElement('div');o.className='original-content';o.innerHTML=b.innerHTML;c.appendChild(o);const t=document.createElement('div');t.className='text-muted';t.textContent=v;c.appendChild(t);b.replaceWith(c)}er.classList.add(S.disabled,S.validated);er.classList.remove(S.editing)})},no=(t,m,d=4000)=>{qa('.ajax-notification').forEach(n=>n.remove());const n=document.createElement('div');n.className=`alert alert-${t==='success'?'success':'danger'} ajax-notification`;n.innerHTML=`<div class="d-flex align-items-center"><span class="flex-grow-1">${m}</span><button type="button" class="close ml-2">&times;</button></div>`;const rm=()=>{n.classList.add('removing');n.addEventListener('animationend',()=>n.remove(),{once:!0})},tm=setTimeout(rm,d);q('.close',n).onclick=()=>{clearTimeout(tm);rm()};document.body.appendChild(n)};return{init(){this.initToggles();this.initMaxValidation();this.preserveScroll();_c=q('#cd');if(!_c)return;_o=_c.dataset.okTitle||'';ib();_c.addEventListener('click',hc,{passive:!1});_c.addEventListener('keydown',hk,{passive:!1})},initToggles(){const st=(a,p)=>{const b=q(`[data-action="${a}"]`);if(b&&!b.dataset.init){b.dataset.init='1';b.addEventListener('click',e=>{e.preventDefault();const bx=qa(`[name^="${p}"]`),al=bx.every(b=>b.checked);bx.forEach(b=>b.checked=!al)})}};st('toggle-dicts','d_');st('toggle-errors','e_');const su=q('[data-action="validate-submit"]');if(su&&!su.dataset.init){su.dataset.init='1';su.addEventListener('click',()=>{if(typeof showOverlay==='function')showOverlay()})}},initMaxValidation(){const m=q('input[name="max"]');if(!m)return;const l=m.getAttribute('max');if(!l)return;m.type='number';m.min='1';m.addEventListener('input',e=>{const v=parseInt(e.target.value),lm=parseInt(l);e.target.setCustomValidity(v>lm?`Limité à ${lm} résultats`:'');e.target.reportValidity()})},preserveScroll(){window.addEventListener('beforeunload',()=>{sessionStorage.setItem('checkDataScroll',window.scrollY)});const sv=sessionStorage.getItem('checkDataScroll');if(sv){R(()=>{window.scrollTo(0,parseInt(sv));sessionStorage.removeItem('checkDataScroll')})}}}})();