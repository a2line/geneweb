<!-- $Id: modules/arbre_vertical v7.00 06/02/2022 01:13:59 Arbre ascendant vertical -->
%define;widow(xxx,yyy,nnn)
   %if;(nnn=0)[*widower/widow:::xxx:yyy]1%else;[*widower/widow:::xxx:yyy]0%end;
%end;
%define;a_tree_line()
  %if;(not is_first)
    <tr>
      %foreach;cell;
        %if;(not is_first)
          <td class="text-center"><samp>&nbsp;</samp></td>
        %end;
        <td colspan="%cell.colspan;" class="text-center py-0 mx-0">%nn;
          %if;(cell.is_empty or cell.is_top)<samp>&nbsp;</samp>%else;│%end;
        </td>
      %end;
    </tr>
  %end;
  <tr>
    %foreach;cell;
      %if;(not is_first)
        <td class="text-center"><samp>&nbsp;</samp></td>
      %end;
      <td colspan="%cell.colspan;"%( style="max-width:%expr(1024/(2^(e.v-1)))px"%) class="col-1 text-center align-bottom py-0">%nn;
        %if;(cell.is_empty)<samp>&nbsp;</samp>%nn;
        %else;
          %if;(e.im="" and cell.person.has_image)
            %if;not cancel_links;<a href="%cell.person.image_html_url;">%end;
            <img class="rounded mb-1" src="%cell.person.image_url;"%cell.person.image_small_size;%sp;%nn;
             alt="[image/images]0" title="[image/images]0"%/>%nn;
            %if;not cancel_links;</a>%end;<br>
          %end;
          %apply;short_display_person_tree("cell.person")%nn;
          %if;cell.person.has_nobility_titles;<br>%cell.person.title;%end;
        %end;
      </td>
    %end;
  </tr>
  %if;(not is_last)
    <tr>
    %foreach;cell;
      %if;(not is_first)
        <td class="text-center py-0">%nn;
        %if;cell.is_right;
          %if;(e.ma!="0")
            %if;(wizard and not cancel_links)
              <a class="small font-italic text-center text-nowrap"
                href="%prefix_base_password;m=MOD_FAM;i=%cell.family.index;;ip=%index;"
                title="%if;(cell.family.marriage_date.year="")[*add::marriage/marriages]0
                     %else;[*update::family/families]0%end; %cell.family.father; [and] %cell.family.mother;">%end;
                %if;(cell.family.marriage_date.year!="")
                  %let;prntsdead;%if;(cell.family.father.death_date.year!="" and cell.family.father.death_date.prec="" and cell.family.mother.death_date.year!="" and cell.family.mother.death_date.prec="")1%end;%in;
                  %let;fwy;
                    %if;(prntsdead=1)
                      %if;(cell.family.father.death_date.year-cell.family.mother.death_date.year=0)1%elseif;(cell.family.father.death_date.year-cell.family.mother.death_date.year<0)0%else;3%end;
                    %else;
                      %if;(cell.family.father.death_date.year!="" and cell.family.father.death_date.prec="")2%nn;
                      %elseif;(cell.family.mother.death_date.year!="" and cell.family.mother.death_date.prec="")4;%nn;
                      %end;
                    %end;
                  %in;
                  %let;fwy_date;
                    %if;(fwy<3)%if;(fwy=2)?%end;%cell.family.father.death_date.year;%nn;
                    %elseif;(fwy>2)%if;(fwy=4)?%end;%cell.family.mother.death_date.year;%nn;
                    %end;
                  %in;
                  %( TODO: — also calculate relation length if couple alive 
                           — print if widow remaried or not
                           - test variable before = debug gwd log
                           - rethink render (color/bold..) %)
                  %if;plugin.v7;
                    %if;(fwy!="" and not ("–" in cell.family.dates)) 
                       %cell.family.dates;–<span class="font-weight-bold %if;(fwy=0)female%elseif;(fwy=1)female%end;" title="%if;(prntsdead=1)%nn;
                         %apply;a_of_b%with;%expr(fwy_date-cell.family.dates) [years old]%and;[relation/relations]0%end;
                         %apply;a_of_b%with;
                           %if;(fwy=0 or fwy=3).%sp;
                             %apply;widow%with;%if;(fwy=0)%cell.family.mother;%else;%cell.family.father;%end;
                               %and;%if;(fwy=0)%if;(cell.family.mother.is_dead)[since/for]1%else;[since/for]0%end;
                                    %else;%if;(cell.family.father.is_dead)[since/for]1%else;[since/for]0%end;
                                    %end;
                               %and;%if;(fwy=0)0%end;
                               %end;
                             %if;(fwy=0) %expr(cell.family.mother.death_date.year-cell.family.father.death_date.year)%nn;
                             %else; %expr(cell.family.father.death_date.year-cell.family.mother.death_date.year)%end; [years old]%nn;
                           %end;
                         %and;%if;(fwy=0)%cell.family.father;%else;%cell.family.mother;%end;
                         %end;.
                       %end;">%fwy_date;</span>
                    %else;
                      <span class="mr-4">%cell.family.dates;</span>
                    %end;
                  %else;%cell.family.marriage.date_s;%end;
                %elseif;(wizard and not cancel_links)-%nn;
                %end;
            %if;(wizard and not cancel_links)</a>%end;
          %else;<samp>&nbsp;</samp>
          %end;
        %else;<samp>&nbsp;</samp>
        %end;
        </td>
      %end;
      <td colspan="%cell.colspan;" class="text-center py-0">%nn;
        %if;cell.is_empty;<samp>&nbsp;</samp>%nn;
        %elseif;(cancel_links)│%nn;
        %else;
          <a href="%cell.person.bname_prefix;%cell.person.access;%nn;
            &m=%if;(e.m!="")%e.m;%else;A%end;%nn;
            &t=%if;(e.t!="")%e.t;%else;T%end;%nn;
            &v=%if;(e.v!="")%e.v;%else;3%end;%nn;
            %if;(e.im=0)&im=0%end;%nn;
            %if;(e.ma=0)&ma=0%end;"
            title="%if;(e.m="")[*tree][:] [full width/columns]0%end;">│</a>%nn;
        %end;
      </td>
    %end;
    </tr>
    <tr>
      %foreach;cell;
        %if;(not is_first)
          <td colspan="1" class="text-center px-0 py-0">%nn;
          %if;(cell.is_right)<hr class="full;"%/>%nn;
          %else;%(<samp>&nbsp;</samp>%)%end;
          </td>
        %end;
        <td colspan="%cell.colspan;" class="px-0 py-0 text-%nn;
           %if;cell.is_left;%right;
           %elseif;cell.is_right;%left;
           %else;center%end;">%nn;
          %if;cell.is_empty;%(<samp>&nbsp;</samp>%)%nn;
          %elseif;cell.is_left;<hr class="%right;"%/>%nn;
          %elseif;cell.is_right;<hr class="%left;"%/>%nn;
          %else;%(│%)%end;
        </td>
      %end;
    </tr>
  %end;
%end;
%define;male_line(xx, yy)
  %if;(yy>0)
    %if;(xx.has_parents)%apply;male_line("xx.father", yy - 1)%end;
    <a href="%xx.bname_prefix;%xx.access">%xx;</a>%xx.title;%xx.dates;
    %if;(e.im="" and xx.has_image)
      <br>
      %if;not cancel_links;<a href="%xx.image_html_url;">%end;
      <img class="rounded" src="%xx.image_url;"%xx.image_small_size;%sp;%nn;
       alt="[image/images]0" title="[image/images]0"%/>
      %if;not cancel_links;</a>%end;
    %end;
    %if;("xx" != "self")<br>│<br>%end;
  %end;%nl;
%end;
%define;female_line(xx, yy)
  %if;(yy>0)
    %if;(xx.has_parents)%apply;female_line("xx.mother", yy - 1)%end;
    <a href="%xx.bname_prefix;%xx.access">%xx;</a>%xx.title;%xx.dates;
    %if;(e.im="" and xx.has_image)
      <br>
      %if;not cancel_links;<a href="%xx.image_html_url;">%end;
      <img class="rounded" src="%xx.image_url;"%xx.image_small_size;%sp;%nn;
       alt="[image/images]0" title="[image/images]0"%/>%nn;
      %if;not cancel_links;</a>%end;
    %end;
    %if;("xx" != "self")<br>│<br>%end;
  %end;%nl;
%end;
%define;tree(xx)
  %foreach;ancestor_tree_line(xx)
    %apply;a_tree_line()
  %end;
%end;
%let;gen;%if;(e.v!="")%e.v;%else;3%end;%in;
%if;not cancel_links;
  <div class="d-flex justify-content-center">
    %include;buttons_dag
  </div>
%end;
%if;has_parents;
  <table class="tree-vert mx-auto my-3" style="border-width:%border;">
    %if;(e.t="T" and e.t1="m")
      %include;modules/arbre_9gen
    %elseif(e.t="A" or e.t="C")
      %if;(e.t="A")
        <tr>
          <td class="text-center">
            %apply;male_line("self", gen)
          </td>
        </tr>
      %elseif;(e.t="C")
        <tr>
          <td class="text-center">
            %apply;female_line("self", gen)
          </td>
        </tr>
      %end;
    %else;
      %apply;tree(gen)
    %end;
  </table>
%end;
